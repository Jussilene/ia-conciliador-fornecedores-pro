<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>IA Conciliador de Fornecedores PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }
      .badge {
        @apply inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium;
      }
    </style>
  </head>

  <body class="min-h-screen bg-slate-950 text-slate-100">
    <div
      class="min-h-screen px-4 py-8 bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 flex justify-center"
    >
      <main class="w-full max-w-6xl space-y-8">
        <!-- Cabe√ßalho -->
        <header class="flex flex-col gap-2">
          <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">
            IA Conciliador de Fornecedores
            <span class="text-emerald-400">PRO</span>
          </h1>
          <p class="text-sm md:text-base text-slate-300 max-w-2xl">
            Fa√ßa o upload da
            <span class="font-semibold">Raz√£o, Balancete, Contas a Pagar</span> e
            <span class="font-semibold">Pagamentos</span> para um fornecedor
            espec√≠fico e receba um diagn√≥stico autom√°tico com diverg√™ncias e
            recomenda√ß√µes. Na
            <span class="font-semibold">Rodada 4</span> voc√™ tamb√©m cruza com as
            <span class="font-semibold">Notas Fiscais</span>.
          </p>

          <!-- üëá Novo: exibi√ß√£o do usu√°rio logado -->
          <div class="text-xs text-slate-300">
            Logado como: <span id="userNameDisplay"></span>
          </div>
        </header>

        <!-- BLOCO 1 ‚Äì Formul√°rio de Upload -->
        <section
          class="bg-slate-900/60 border border-slate-800 rounded-2xl p-5 md:p-6 shadow-xl shadow-slate-950/40"
        >
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg md:text-xl font-semibold">
              1. Upload dos arquivos e fornecedor
            </h2>
          </div>

          <form id="conciliacaoForm" class="space-y-4">
            <!-- Fornecedor + Tipo de concilia√ß√£o -->
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label
                  for="fornecedorInput"
                  class="block text-sm font-medium text-slate-200 mb-1"
                  >Fornecedor</label
                >
                <input
                  id="fornecedorInput"
                  type="text"
                  required
                  placeholder="Ex: SANEATINS, MERCADO XYZ..."
                  class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-sm md:text-base outline-none focus:ring-2 focus:ring-emerald-400/80 focus:border-emerald-400/80"
                />
                <p class="text-xs mt-1 text-slate-400">
                  Use o mesmo nome que aparece na raz√£o / contas a pagar.
                </p>
              </div>

              <div>
                <label
                  for="tipoConcilicacao"
                  class="block text-sm font-medium text-slate-200 mb-1"
                  >Tipo de concilia√ß√£o</label
                >
                <select
                  id="tipoConcilicacao"
                  class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-sm md:text-base outline-none focus:ring-2 focus:ring-emerald-400/80 focus:border-emerald-400/80"
                >
                  <option value="rodada1">Concilia√ß√£o padr√£o (Rodada 1)</option>
                  <option value="rodada2">
                    Fornecedor estrat√©gico (Rodada 2)
                  </option>
                  <option value="rodada3">
                    Auditoria mensal (Rodada 3)
                  </option>
                  <option value="rodada4">
                    Notas fiscais cruzadas (Rodada 4)
                  </option>
                </select>
                <p class="text-xs mt-1 text-slate-400">
                  Selecione
                  <span class="font-semibold">Fornecedor estrat√©gico</span> para
                  aplicar regras mais r√≠gidas (Rodada 2),
                  <span class="font-semibold">Auditoria mensal</span> para uma
                  vis√£o consolidada do m√™s (Rodada 3) ou
                  <span class="font-semibold">Notas fiscais cruzadas</span> para
                  comparar NFs com t√≠tulos, raz√£o e pagamentos (Rodada 4).
                </p>
              </div>
            </div>

            <!-- Arquivos -->
            <div
              class="grid md:grid-cols-2 gap-4 border border-slate-800 rounded-xl p-3 md:p-4 bg-slate-950/50"
            >
              <div>
                <label
                  for="razaoFile"
                  class="block text-sm font-medium text-slate-200 mb-1"
                  >Raz√£o de Fornecedores (PDF)</label
                >
                <input
                  id="razaoFile"
                  name="razao"
                  type="file"
                  accept=".pdf"
                  required
                  class="block w-full text-xs md:text-sm text-slate-100 file:mr-3 file:rounded-lg file:border-0 file:bg-emerald-500 file:px-3 file:py-1.5 file:text-xs file:font-medium file:text-slate-900 hover:file:bg-emerald-400 cursor-pointer"
                />
              </div>

              <div>
                <label
                  for="balanceteFile"
                  class="block text-sm font-medium text-slate-200 mb-1"
                  >Balancete de Fornecedores (PDF)</label
                >
                <input
                  id="balanceteFile"
                  name="balancete"
                  type="file"
                  accept=".pdf"
                  required
                  class="block w-full text-xs md:text-sm text-slate-100 file:mr-3 file:rounded-lg file:border-0 file:bg-emerald-500 file:px-3 file:py-1.5 file:text-xs file:font-medium file:text-slate-9
00 hover:file:bg-emerald-400 cursor-pointer"
                />
              </div>

              <div>
                <label
                  for="contasFile"
                  class="block text-sm font-medium text-slate-200 mb-1"
                  >Contas a Pagar (PDF)</label
                >
                <input
                  id="contasFile"
                  name="contas_pagar"
                  type="file"
                  accept=".pdf"
                  required
                  class="block w-full text-xs md:text-sm text-slate-100 file:mr-3 file:rounded-lg file:border-0 file:bg-emerald-500 file:px-3 file:py-1.5 file:text-xs file:font-medium file:text-slate-900 hover:file:bg-emerald-400 cursor-pointer"
                />
              </div>

              <div>
                <label
                  for="pagamentosFile"
                  class="block text-sm font-medium text-slate-200 mb-1"
                  >Pagamentos / Extrato (PDF)</label
                >
                <input
                  id="pagamentosFile"
                  name="pagamentos"
                  type="file"
                  accept=".pdf"
                  required
                  class="block w-full text-xs md:text-sm text-slate-100 file:mr-3 file:rounded-lg file:border-0 file:bg-emerald-500 file:px-3 file:py-1.5 file:text-xs file:font-medium file:text-slate-900 hover:file:bg-emerald-400 cursor-pointer"
                />
              </div>

              <!-- Notas Fiscais (s√≥ aparece na Rodada 4) -->
              <div
                id="notasFiscaisWrapper"
                class="md:col-span-2 hidden"
              >
                <label
                  for="notasFiscaisFile"
                  class="block text-sm font-medium text-slate-200 mb-1"
                  >Notas Fiscais (PDF/CSV) ‚Äì obrigat√≥rio na Rodada 4</label
                >
                <input
                  id="notasFiscaisFile"
                  name="notas_fiscais"
                  type="file"
                  accept=".pdf,.csv"
                  class="block w-full text-xs md:text-sm text-slate-100 file:mr-3 file:rounded-lg file:border-0 file:bg-emerald-500 file:px-3 file:py-1.5 file:text-xs file:font-medium file:text-slate-900 hover:file:bg-emerald-400 cursor-pointer"
                />
                <p class="text-xs mt-1 text-slate-400">
                  Na Rodada 4 este arquivo √© obrigat√≥rio. Nas demais rodadas √©
                  opcional.
                </p>
              </div>
            </div>

            <!-- Bot√£o -->
            <div class="flex flex-wrap items-center gap-3 pt-1">
              <button
                id="submitBtn"
                type="submit"
                class="inline-flex items-center gap-2 rounded-xl bg-emerald-500 px-4 py-2 text-sm md:text-base font-semibold text-slate-950 shadow-lg shadow-emerald-500/30 hover:bg-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-300 disabled:opacity-60 disabled:cursor-not-allowed"
              >
                <span id="submitBtnIcon" class="text-lg">‚öôÔ∏è</span>
                <span id="submitBtnText">Rodar concilia√ß√£o</span>
              </button>

              <p
                id="statusMensagem"
                class="text-xs md:text-sm text-slate-400 italic"
              >
                Aguardando envio...
              </p>
            </div>
          </form>
        </section>

        <!-- BLOCO 2 ‚Äì Status da Concilia√ß√£o -->
        <section
          class="bg-slate-900/60 border border-slate-800 rounded-2xl p-5 md:p-6 shadow-xl shadow-slate-950/40"
        >
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg md:text-xl font-semibold">
              2. Status da concilia√ß√£o
            </h2>
          </div>

          <div
            id="statusResultado"
            class="grid md:grid-cols-4 gap-3 text-sm md:text-base"
          >
            <div
              class="rounded-xl border border-slate-800 bg-slate-950/60 p-3 space-y-1"
            >
              <p class="text-xs uppercase tracking-wide text-slate-400">
                Fornecedor
              </p>
              <p
                id="statusFornecedor"
                class="font-semibold text-slate-100 break-words"
              >
                ‚Äî
              </p>
            </div>

            <div
              class="rounded-xl border border-slate-800 bg-slate-950/60 p-3 space-y-1"
            >
              <p class="text-xs uppercase tracking-wide text-slate-400">
                Etapa
              </p>
              <p id="statusEtapa" class="font-semibold text-slate-100">‚Äî</p>
            </div>

            <div
              class="rounded-xl border border-slate-800 bg-slate-950/60 p-3 space-y-1"
            >
              <p class="text-xs uppercase tracking-wide text-slate-400">
                Status
              </p>
              <p id="statusConciliacao" class="font-semibold text-emerald-400">
                ‚Äî
              </p>
            </div>

            <div
              class="rounded-xl border border-slate-800 bg-slate-950/60 p-3 space-y-1"
            >
              <p class="text-xs uppercase tracking-wide text-slate-400">
                Modelo / Regra
              </p>
              <p id="statusModelo" class="font-semibold text-slate-100">‚Äî</p>
            </div>
          </div>

          <!-- Card: Fornecedor estrat√©gico + CNPJs/CPFs -->
          <div
            id="cardFornecedorEstrategico"
            class="mt-4 rounded-xl border border-emerald-700/60 bg-emerald-950/40 p-3 md:p-4 text-sm md:text-base hidden"
          >
            <div class="flex items-start justify-between gap-2">
              <div>
                <p class="text-xs uppercase tracking-wide text-emerald-300">
                  Fornecedor estrat√©gico
                </p>
                <p class="text-sm md:text-base text-emerald-100">
                  An√°lise com regras refor√ßadas de severidade para este
                  fornecedor.
                </p>
              </div>
              <span
                class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-emerald-500/20 text-emerald-100"
              >
                PRO
              </span>
            </div>
            <div
              id="identificadoresConteudo"
              class="mt-2 text-xs md:text-sm text-emerald-100 space-y-1"
            ></div>
          </div>

          <!-- Alerta de risco elevado -->
          <div
            id="alertaRisco"
            class="mt-3 rounded-xl border border-rose-600/70 bg-rose-950/40 p-3 md:p-4 text-sm md:text-base hidden"
          >
            <div class="flex items-start gap-2">
              <span class="text-lg">‚ö†Ô∏è</span>
              <p id="alertaRiscoTexto" class="text-rose-100">
                <!-- preenchido via JS -->
              </p>
            </div>
          </div>
        </section>

        <!-- BLOCO 3 ‚Äì Resumo Executivo -->
        <section
          class="bg-slate-900/60 border border-slate-800 rounded-2xl p-5 md:p-6 shadow-xl shadow-slate-950/40"
        >
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg md:text-xl font-semibold">
              3. Resumo executivo
            </h2>
          </div>
          <p
            id="resumoExecutivo"
            class="text-sm md:text-base text-slate-200 leading-relaxed"
          >
            Nenhuma concilia√ß√£o processada ainda.
          </p>
        </section>

        <!-- BLOCO 4 ‚Äì Lista de Diverg√™ncias -->
        <section
          class="bg-slate-900/60 border border-slate-800 rounded-2xl p-5 md:p-6 shadow-xl shadow-slate-950/40"
        >
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg md:text-xl font-semibold">
              4. Diverg√™ncias encontradas
            </h2>
          </div>

          <div id="divergenciasContainer" class="space-y-3 text-sm md:text-base">
            <p class="text-slate-300">
              Ainda n√£o h√° diverg√™ncias listadas. Rode uma concilia√ß√£o para ver
              os detalhes aqui.
            </p>
          </div>

          <!-- Sub-bloco: Diverg√™ncias espec√≠ficas de Notas Fiscais -->
          <div
            class="mt-4 rounded-xl border border-slate-800 bg-slate-950/60 p-3 space-y-2"
          >
            <h3 class="font-semibold text-slate-100 mb-1">
              Notas fiscais ‚Äì diverg√™ncias espec√≠ficas (Rodada 4)
            </h3>
            <div
              id="divergenciasNotasFiscaisConteudo"
              class="space-y-2 text-slate-300 text-sm md:text-base"
            >
              <p class="text-slate-400 text-sm">
                As diverg√™ncias espec√≠ficas de notas fiscais aparecer√£o aqui
                quando voc√™ utilizar a Rodada 4.
              </p>
            </div>
          </div>
        </section>

        <!-- BLOCO 5 ‚Äì T√≠tulos vencidos e pagamentos √≥rf√£os -->
        <section
          class="bg-slate-900/60 border border-slate-800 rounded-2xl p-5 md:p-6 shadow-xl shadow-slate-950/40"
        >
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg md:text-xl font-semibold">
              5. T√≠tulos vencidos & pagamentos √≥rf√£os
            </h2>
          </div>

          <div class="grid md:grid-cols-2 gap-4 text-sm md:text-base">
            <!-- T√≠tulos vencidos -->
            <div
              id="titulosContainer"
              class="rounded-xl border border-slate-800 bg-slate-950/60 p-3 space-y-2"
            >
              <h3 class="font-semibold text-slate-100 mb-1">
                T√≠tulos vencidos sem contrapartida
              </h3>
              <div id="titulosConteudo" class="space-y-2 text-slate-300">
                <p class="text-slate-400 text-sm">
                  Nenhuma informa√ß√£o de t√≠tulos vencidos ainda.
                </p>
              </div>
            </div>

            <!-- Pagamentos √≥rf√£os -->
            <div
              id="pagamentosOrfaosContainer"
              class="rounded-xl border border-slate-800 bg-slate-950/60 p-3 space-y-2"
            >
              <h3 class="font-semibold text-slate-100 mb-1">
                Pagamentos √≥rf√£os
              </h3>
              <div id="pagamentosOrfaosConteudo" class="space-y-2 text-slate-300">
                <p class="text-slate-400 text-sm">
                  Nenhum pagamento √≥rf√£o foi identificado.
                </p>
              </div>
            </div>
          </div>

          <!-- Passos recomendados / observa√ß√µes -->
          <div class="mt-4 grid md:grid-cols-2 gap-4 text-sm md:text-base">
            <div
              class="rounded-xl border border-slate-800 bg-slate-950/60 p-3 space-y-2"
            >
              <h3 class="font-semibold text-slate-100 mb-1">
                Passos recomendados
              </h3>
              <ul
                id="passosRecomendados"
                class="space-y-1 text-slate-300 list-disc list-inside"
              >
                <li class="text-slate-400 text-sm">
                  As recomenda√ß√µes da IA aparecer√£o aqui ap√≥s a concilia√ß√£o.
                </li>
              </ul>
            </div>

            <div
              class="rounded-xl border border-slate-800 bg-slate-950/60 p-3 space-y-2"
            >
              <h3 class="font-semibold text-slate-100 mb-1">
                Observa√ß√µes gerais
              </h3>
              <p
                id="observacoesGerais"
                class="text-slate-300 text-sm md:text-base"
              >
                As observa√ß√µes gerais sobre o fornecedor aparecer√£o aqui.
              </p>
            </div>
          </div>
        </section>

        <!-- BLOCO 6 ‚Äì Resumo da auditoria mensal (Rodada 3) -->
        <section
          id="blocoAuditoriaMensal"
          class="bg-slate-900/60 border border-slate-800 rounded-2xl p-5 md:p-6 shadow-xl shadow-slate-950/40 mb-6 hidden"
        >
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg md:text-xl font-semibold">
              6. Resumo da auditoria mensal
            </h2>
          </div>

          <div class="grid md:grid-cols-2 gap-4 text-sm md:text-base">
            <!-- Totais mensais -->
            <div
              class="rounded-xl border border-slate-800 bg-slate-950/60 p-3 space-y-2"
            >
              <h3 class="font-semibold text-slate-100 mb-1">
                Vis√£o consolidada do m√™s
              </h3>
              <ul class="space-y-1 text-slate-300">
                <li>
                  Lan√ßamentos na raz√£o:
                  <span
                    id="resumoMensalLancamentosRazao"
                    class="font-semibold text-emerald-300"
                    >‚Äî</span
                  >
                </li>
                <li>
                  T√≠tulos no contas a pagar:
                  <span
                    id="resumoMensalTitulosContasPagar"
                    class="font-semibold text-emerald-300"
                    >‚Äî</span
                  >
                </li>
                <li>
                  Movimentos de pagamento:
                  <span
                    id="resumoMensalTotalPagamentos"
                    class="font-semibold text-emerald-300"
                    >‚Äî</span
                  >
                </li>
                <li>
                  Total de diverg√™ncias:
                  <span
                    id="resumoMensalTotalDivergencias"
                    class="font-semibold text-emerald-300"
                    >‚Äî</span
                  >
                </li>
              </ul>
            </div>

            <!-- Diverg√™ncias por tipo -->
            <div
              class="rounded-xl border border-slate-800 bg-slate-950/60 p-3 space-y-2"
            >
              <h3 class="font-semibold text-slate-100 mb-1">
                Diverg√™ncias por tipo
              </h3>
              <div
                id="divergenciasPorTipoConteudo"
                class="space-y-1 text-slate-300"
              >
                <p class="text-slate-400 text-sm">
                  Ainda n√£o h√° dados de auditoria mensal. Rode a Rodada 3 para
                  ver o consolidado.
                </p>
              </div>
            </div>
          </div>

          <!-- Coment√°rio da auditoria -->
          <div
            class="mt-4 rounded-xl border border-slate-800 bg-slate-950/60 p-3 md:p-4 space-y-2 text-sm md:text-base"
          >
            <h3 class="font-semibold text-slate-100 mb-1">
              Parecer da auditoria
            </h3>
            <p id="comentarioAuditoria" class="text-slate-300">
              Nenhum parecer mensal gerado ainda. Utilize a op√ß√£o "Auditoria
              mensal (Rodada 3)" para consolidar o m√™s.
            </p>
          </div>
        </section>
      </main>
    </div>

    <!-- üëá Novo: script da sess√£o (n√£o mexe no que j√° existe) -->
    <script src="/js/session.js"></script>

    <!-- SCRIPT -->
    <script>
      const form = document.getElementById("conciliacaoForm");
      const submitBtn = document.getElementById("submitBtn");
      const submitBtnText = document.getElementById("submitBtnText");
      const submitBtnIcon = document.getElementById("submitBtnIcon");
      const statusMensagem = document.getElementById("statusMensagem");

      const statusFornecedor = document.getElementById("statusFornecedor");
      const statusEtapa = document.getElementById("statusEtapa");
      const statusConciliacao = document.getElementById("statusConciliacao");
      const statusModelo = document.getElementById("statusModelo");

      const cardFornecedorEstrategico = document.getElementById(
        "cardFornecedorEstrategico"
      );
      const identificadoresConteudo = document.getElementById(
        "identificadoresConteudo"
      );
      const alertaRisco = document.getElementById("alertaRisco");
      const alertaRiscoTexto = document.getElementById("alertaRiscoTexto");

      const resumoExecutivo = document.getElementById("resumoExecutivo");
      const divergenciasContainer =
        document.getElementById("divergenciasContainer");
      const divergenciasNotasFiscaisConteudo = document.getElementById(
        "divergenciasNotasFiscaisConteudo"
      );
      const titulosConteudo = document.getElementById("titulosConteudo");
      const pagamentosOrfaosConteudo = document.getElementById(
        "pagamentosOrfaosConteudo"
      );
      const passosRecomendados = document.getElementById("passosRecomendados");
      const observacoesGerais = document.getElementById("observacoesGerais");

      // Elementos da auditoria mensal (Rodada 3)
      const resumoMensalLancamentosRazao = document.getElementById(
        "resumoMensalLancamentosRazao"
      );
      const resumoMensalTitulosContasPagar = document.getElementById(
        "resumoMensalTitulosContasPagar"
      );
      const resumoMensalTotalPagamentos = document.getElementById(
        "resumoMensalTotalPagamentos"
      );
      const resumoMensalTotalDivergencias = document.getElementById(
        "resumoMensalTotalDivergencias"
      );
      const divergenciasPorTipoConteudo = document.getElementById(
        "divergenciasPorTipoConteudo"
      );
      const comentarioAuditoria = document.getElementById("comentarioAuditoria");
      const blocoAuditoriaMensal = document.getElementById(
        "blocoAuditoriaMensal"
      );

      // Rodada / NF
      const tipoConcilicacao = document.getElementById("tipoConcilicacao");
      const notasFiscaisWrapper = document.getElementById(
        "notasFiscaisWrapper"
      );
      const notasFiscaisInput = document.getElementById("notasFiscaisFile");

      // üîπ Guarda a √∫ltima rodada selecionada (1, 2, 3 ou 4)
      let ultimaRodadaSelecionada = "rodada1";

      function setLoading(isLoading) {
        submitBtn.disabled = isLoading;
        if (isLoading) {
          submitBtnIcon.textContent = "‚è≥";
          submitBtnText.textContent = "Processando concilia√ß√£o...";
          statusMensagem.textContent =
            "Lendo PDFs, cruzando informa√ß√µes e gerando diagn√≥stico. Aguarde...";
        } else {
          submitBtnIcon.textContent = "‚öôÔ∏è";
          submitBtnText.textContent = "Rodar concilia√ß√£o";
        }
      }

      function getBadgeClasses(nivel) {
        const base =
          "inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium";
        if (!nivel) return base + " bg-slate-800 text-slate-200";
        const n = nivel.toLowerCase();
        if (n === "alta") return base + " bg-rose-500/20 text-rose-300";
        if (n === "media") return base + " bg-amber-500/20 text-amber-300";
        if (n === "baixa") return base + " bg-emerald-500/20 text-emerald-300";
        return base + " bg-slate-800 text-slate-200";
      }

      function formatCurrency(valor) {
        if (typeof valor !== "number" || isNaN(valor)) return "-";
        return "R$ " + valor.toFixed(2);
      }

      function atualizarVisibilidadeNotasFiscais() {
        const rodada = tipoConcilicacao.value;
        if (rodada === "rodada4") {
          notasFiscaisWrapper.classList.remove("hidden");
          notasFiscaisInput.required = true;
        } else {
          notasFiscaisWrapper.classList.add("hidden");
          notasFiscaisInput.required = false;
        }
      }

      // j√° configura ao carregar
      atualizarVisibilidadeNotasFiscais();
      tipoConcilicacao.addEventListener("change", atualizarVisibilidadeNotasFiscais);

      function renderResultado(data) {
        console.log("üîé RESPOSTA DA API:", data);

        const fornecedor = data.fornecedor || "-";

        // üîπ Objeto principal de concilia√ß√£o e estrutura
        const conciliacao = data.conciliacao || {};
        const estrutura = conciliacao.estrutura || {};

        console.log("üîé ESTRUTURA:", estrutura);

        // ‚úÖ Etapa vinda do backend (para exibi√ß√£o)
        let etapaBruta =
          data.rodada ||
          data.etapa ||
          ultimaRodadaSelecionada ||
          "rodada1";

        if (!["rodada1", "rodada2", "rodada3", "rodada4"].includes(etapaBruta)) {
          etapaBruta = ultimaRodadaSelecionada || "rodada1";
        }

        const perfilFornecedor =
          conciliacao.perfilFornecedor ||
          data.perfilFornecedor ||
          estrutura.perfilFornecedor ||
          "";

        let etapaLabel;
        if (etapaBruta === "rodada1") {
          etapaLabel = "rodada1";
        } else if (etapaBruta === "rodada2") {
          etapaLabel = "rodada2 (estrategico)";
        } else if (etapaBruta === "rodada3") {
          etapaLabel = "rodada3 (auditoria mensal)";
        } else if (etapaBruta === "rodada4") {
          etapaLabel = "rodada4 (notas fiscais)";
        } else {
          etapaLabel = etapaBruta || "-";
        }

        const modelo = conciliacao.modelo || conciliacao.status || "-";
        const status = conciliacao.status || "‚Äî";

        const etapaFinal = etapaLabel;

        // Bloco 2
        statusFornecedor.textContent = fornecedor;
        statusEtapa.textContent = etapaFinal || "-";
        statusConciliacao.textContent = status;
        statusModelo.textContent = modelo;

        // Sempre LIMPA antes de preencher o novo
        cardFornecedorEstrategico.classList.add("hidden");
        identificadoresConteudo.innerHTML = "";

        // Coleta os identificadores enviados pelo backend
        const identificadores = estrutura.identificadoresFornecedor || {};
        const cnpjs = Array.isArray(identificadores.cnpjs)
          ? identificadores.cnpjs
          : [];
        const cpfs = Array.isArray(identificadores.cpfs)
          ? identificadores.cpfs
          : [];

        const temIdentificadores = cnpjs.length > 0 || cpfs.length > 0;

        // Exibe somente se perfil = estrat√©gico E houver CNPJ/CPF no relat√≥rio
        if (perfilFornecedor === "estrategico" && temIdentificadores) {
          cardFornecedorEstrategico.classList.remove("hidden");

          let html = "";

          if (cnpjs.length) {
            html += `<p><span class="font-semibold">CNPJ(s) encontrados nos relat√≥rios:</span> ${cnpjs.join(
              " ¬∑ "
            )}</p>`;
          }

          if (cpfs.length) {
            html += `<p><span class="font-semibold">CPF(s) relacionados:</span> ${cpfs.join(
              " ¬∑ "
            )}</p>`;
          }

          identificadoresConteudo.innerHTML = html;
        }

        // Bloco 3 ‚Äì Resumo
        resumoExecutivo.textContent =
          estrutura.resumoExecutivo ||
          "Nenhum resumo executivo retornado para esta concilia√ß√£o.";

        // Bloco 4 ‚Äì Diverg√™ncias gerais
        const divergencias = estrutura.divergencias || [];
        if (!divergencias.length) {
          divergenciasContainer.innerHTML =
            '<p class="text-slate-300 text-sm">Nenhuma diverg√™ncia relevante foi identificada para este fornecedor.</p>';
        } else {
          divergenciasContainer.innerHTML = "";
          divergencias.forEach((div, idx) => {
            const card = document.createElement("article");
            card.className =
              "rounded-xl border border-slate-800 bg-slate-950/60 p-3 md:p-4 space-y-1";

            const crit = div.nivelCriticidade || "";
            const referencias = (div.referencias || []).join(" ¬∑ ");
            const valorTexto =
              typeof div.valorEstimado === "number"
                ? formatCurrency(div.valorEstimado)
                : null;

            card.innerHTML = `
              <div class="flex items-start justify-between gap-2">
                <div>
                  <h3 class="font-semibold text-slate-100 text-sm md:text-base">
                    Diverg√™ncia ${idx + 1}
                  </h3>
                  <p class="text-xs text-slate-400">
                    Tipo: <span class="font-medium text-slate-200">${
                      div.tipo || "n√£o informado"
                    }</span>
                  </p>
                  ${
                    valorTexto
                      ? `<p class="text-xs text-slate-400">
                           Valor estimado em risco:
                           <span class="font-semibold text-emerald-300">${valorTexto}</span>
                         </p>`
                      : ""
                  }
                </div>
                <span class="${getBadgeClasses(
                  crit
                )}">${crit || "sem n√≠vel"}</span>
              </div>
              <p class="text-sm md:text-[15px] text-slate-200 mt-2">
                ${div.descricao || "-"}
              </p>
              ${
                referencias
                  ? `<p class="text-xs text-slate-400 mt-1">Refer√™ncias: ${referencias}</p>`
                  : ""
              }
            `;
            divergenciasContainer.appendChild(card);
          });
        }

        // Sub-bloco ‚Äì Diverg√™ncias de Notas Fiscais
        const divergenciasNF =
          estrutura.divergenciasNotasFiscais ||
          conciliacao.divergenciasNotasFiscais ||
          data.divergenciasNotasFiscais ||
          [];

        if (!divergenciasNF.length) {
          if (etapaBruta === "rodada4") {
            divergenciasNotasFiscaisConteudo.innerHTML =
              '<p class="text-slate-400 text-sm">Nenhuma diverg√™ncia espec√≠fica de notas fiscais foi identificada para este fornecedor.</p>';
          } else {
            divergenciasNotasFiscaisConteudo.innerHTML =
              '<p class="text-slate-400 text-sm">As diverg√™ncias espec√≠ficas de notas fiscais aparecem somente quando voc√™ roda a Rodada 4.</p>';
          }
        } else {
          divergenciasNotasFiscaisConteudo.innerHTML = "";
          divergenciasNF.forEach((nf, idx) => {
            const item = document.createElement("article");
            item.className =
              "rounded-lg border border-slate-800 bg-slate-950/80 p-2.5 space-y-1";

            const valorTexto =
              typeof nf.valor === "number" ? formatCurrency(nf.valor) : "-";

            item.innerHTML = `
              <div class="flex items-start justify-between gap-2">
                <div>
                  <p class="text-xs text-slate-400">
                    Tipo: <span class="font-medium text-slate-200">${
                      nf.tipo || "-"
                    }</span>
                  </p>
                  <p class="text-xs text-slate-400">
                    NF: <span class="font-semibold text-emerald-300">${
                      nf.nota || "-"
                    }</span>
                  </p>
                  <p class="text-xs text-slate-400">
                    Valor (quando informado): <span class="font-semibold text-emerald-300">${valorTexto}</span>
                  </p>
                </div>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-slate-800 text-slate-200">
                  NF #${idx + 1}
                </span>
              </div>
              <p class="text-sm text-slate-200">
                ${nf.detalhe || "-"}
              </p>
              ${
                nf.contexto
                  ? `<p class="text-[11px] text-slate-500">Contexto: ${nf.contexto}</p>`
                  : ""
              }
            `;

            divergenciasNotasFiscaisConteudo.appendChild(item);
          });
        }

        // Bloco 5 ‚Äì T√≠tulos vencidos
        const titulos = estrutura.titulosVencidosSemContrapartida || [];
        if (!titulos.length) {
          titulosConteudo.innerHTML =
            '<p class="text-slate-400 text-sm">Nenhum t√≠tulo vencido sem contrapartida foi identificado.</p>';
        } else {
          titulosConteudo.innerHTML = "";
          titulos.forEach((t) => {
            const item = document.createElement("div");
            item.className =
              "rounded-lg border border-slate-800 bg-slate-950/80 p-2.5 space-y-1";
            item.innerHTML = `
              <p class="text-sm text-slate-200">${t.descricao || "-"}</p>
              <p class="text-xs text-slate-400">
                Valor estimado: <span class="font-semibold text-emerald-300">
                  ${formatCurrency(t.valorEstimado)}
                </span>
              </p>
              ${
                t.diasEmAtrasoEstimado != null
                  ? `<p class="text-xs text-slate-400">Dias em atraso (estimado): ${t.diasEmAtrasoEstimado}</p>`
                  : ""
              }
              ${
                (t.referencias || []).length
                  ? `<p class="text-[11px] text-slate-500">Refs: ${(t.referencias || []).join(
                      " ¬∑ "
                    )}</p>`
                  : ""
              }
            `;
            titulosConteudo.appendChild(item);
          });
        }

        // Pagamentos √≥rf√£os
        const orfaos = estrutura.pagamentosOrfaos || [];
        if (!orfaos.length) {
          pagamentosOrfaosConteudo.innerHTML =
            '<p class="text-slate-400 text-sm">Nenhum pagamento √≥rf√£o foi identificado.</p>';
        } else {
          pagamentosOrfaosConteudo.innerHTML = "";
          orfaos.forEach((p) => {
            const item = document.createElement("div");
            item.className =
              "rounded-lg border border-slate-800 bg-slate-950/80 p-2.5 space-y-1";
            item.innerHTML = `
              <p class="text-sm text-slate-200">${p.descricao || "-"}</p>
              <p class="text-xs text-slate-400">
                Valor estimado: <span class="font-semibold text-emerald-300">
                  ${formatCurrency(p.valorEstimado)}
                </span>
              </p>
              ${
                (p.referencias || []).length
                  ? `<p class="text-[11px] text-slate-500">Refs: ${(p.referencias || []).join(
                      " ¬∑ "
                    )}</p>`
                  : ""
              }
            `;
            pagamentosOrfaosConteudo.appendChild(item);
          });
        }

        // Passos recomendados
        const passos = estrutura.passosRecomendados || [];
        if (!passos.length) {
          passosRecomendados.innerHTML =
            '<li class="text-slate-400 text-sm">Nenhum passo recomendado retornado para esta concilia√ß√£o.</li>';
        } else {
          passosRecomendados.innerHTML = "";
          passos.forEach((p) => {
            const li = document.createElement("li");
            li.textContent = p;
            passosRecomendados.appendChild(li);
          });
        }

        // Observa√ß√µes gerais
        observacoesGerais.textContent =
          estrutura.observacoesGerais ||
          "Nenhuma observa√ß√£o geral retornada para esta concilia√ß√£o.";

        // üö® C√°lculo de risco agregado (visual PRO)
        let totalRisco = 0;

        function somaValor(v) {
          if (typeof v === "number" && !isNaN(v)) {
            totalRisco += v;
          }
        }

        divergencias.forEach((d) => somaValor(d.valorEstimado));
        orfaos.forEach((p) => somaValor(p.valorEstimado));
        titulos.forEach((t) => somaValor(t.valorEstimado));
        // diverg√™ncias de NF normalmente s√£o qualitativas, mas se tiver valor, soma tamb√©m
        divergenciasNF.forEach((nf) => somaValor(nf.valor || nf.valorEstimado));

        const qtdAlta = divergencias.filter(
          (d) =>
            (d.nivelCriticidade || "").toString().toLowerCase() === "alta"
        ).length;

        const LIMITE_RISCO = 50000; // R$ 50k

        if (qtdAlta >= 3 || totalRisco > LIMITE_RISCO) {
          alertaRisco.classList.remove("hidden");
          alertaRiscoTexto.textContent =
            "Risco elevado identificado para este fornecedor: " +
            `${qtdAlta} diverg√™ncia(s) de criticidade alta ` +
            `e valor estimado em risco de aproximadamente ${formatCurrency(
              totalRisco
            )}. ` +
            "Priorize a an√°lise e os ajustes deste caso.";
        } else {
          alertaRisco.classList.add("hidden");
          alertaRiscoTexto.textContent = "";
        }

        // üîπ Bloco 6 ‚Äì Auditoria mensal
        // Usa combina√ß√£o: backend dizendo que √© rodada3 E front selecionado em rodada3
        const rodadaFront =
          ultimaRodadaSelecionada || tipoConcilicacao.value || "rodada1";

        const deveMostrarAuditoria =
          (etapaBruta === "rodada3" || etapaBruta === "auditoria_mensal") &&
          rodadaFront === "rodada3";

        if (deveMostrarAuditoria) {
          blocoAuditoriaMensal.classList.remove("hidden");

          const resumoMensal =
            estrutura.resumoMensal ||
            conciliacao.resumoMensal ||
            data.resumoMensal ||
            null;

          const divergenciasPorTipo =
            estrutura.divergenciasPorTipo ||
            conciliacao.divergenciasPorTipo ||
            data.divergenciasPorTipo ||
            [];

          const comentario =
            estrutura.comentarioAuditoria ||
            conciliacao.comentarioAuditoria ||
            data.comentarioAuditoria ||
            "";

          console.log("üîé Resumo mensal:", resumoMensal);
          console.log("üîé Diverg√™ncias por tipo:", divergenciasPorTipo);
          console.log("üîé Coment√°rio auditoria:", comentario);

          if (resumoMensal) {
            resumoMensalLancamentosRazao.textContent =
              resumoMensal.totalLancamentosRazao ?? 0;
            resumoMensalTitulosContasPagar.textContent =
              resumoMensal.totalTitulosContasPagar ?? 0;
            resumoMensalTotalPagamentos.textContent =
              resumoMensal.totalPagamentos ?? 0;
            resumoMensalTotalDivergencias.textContent =
              resumoMensal.totalDivergencias ?? 0;
          } else {
            resumoMensalLancamentosRazao.textContent = "‚Äî";
            resumoMensalTitulosContasPagar.textContent = "‚Äî";
            resumoMensalTotalPagamentos.textContent = "‚Äî";
            resumoMensalTotalDivergencias.textContent = "‚Äî";
          }

          if (divergenciasPorTipo.length) {
            divergenciasPorTipoConteudo.innerHTML = "";
            divergenciasPorTipo.forEach((item) => {
              const row = document.createElement("div");
              row.className =
                "flex items-center justify-between text-xs md:text-sm border border-slate-800/80 rounded-lg px-2 py-1.5 bg-slate-950/70";
              row.innerHTML = `
                <span class="text-slate-200">${item.tipo}</span>
                <span class="text-slate-300">
                  ${item.quantidade} diverg√™ncia(s) ¬∑
                  <span class="font-semibold text-emerald-300">
                    ${formatCurrency(item.valorEstimado)}
                  </span>
                </span>
              `;
              divergenciasPorTipoConteudo.appendChild(row);
            });
          } else {
            divergenciasPorTipoConteudo.innerHTML =
              '<p class="text-slate-400 text-sm">Ainda n√£o h√° dados de auditoria mensal. Rode a Rodada 3 para ver o consolidado.</p>';
          }

          if (comentario) {
            comentarioAuditoria.textContent = comentario;
          } else {
            comentarioAuditoria.textContent =
              'Nenhum parecer mensal gerado ainda. Utilize a op√ß√£o "Auditoria mensal (Rodada 3)" para consolidar o m√™s.';
          }
        } else {
          // üëâ Demais rodadas (1, 2 e 4): esconde completamente o bloco 6
          blocoAuditoriaMensal.classList.add("hidden");

          // Limpa/zera o conte√∫do para n√£o ficar "resto" visual
          resumoMensalLancamentosRazao.textContent = "‚Äî";
          resumoMensalTitulosContasPagar.textContent = "‚Äî";
          resumoMensalTotalPagamentos.textContent = "‚Äî";
          resumoMensalTotalDivergencias.textContent = "‚Äî";
          divergenciasPorTipoConteudo.innerHTML =
            '<p class="text-slate-400 text-sm">Este resumo √© exclusivo da Auditoria mensal (Rodada 3).</p>';
          comentarioAuditoria.textContent =
            'Resumo mensal desativado para esta rodada. Use "Auditoria mensal (Rodada 3)" para gerar o consolidado.';
        }

        statusMensagem.textContent =
          "Concilia√ß√£o conclu√≠da com sucesso para o fornecedor " +
          fornecedor +
          ".";
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const fornecedor = document.getElementById("fornecedorInput").value;
        const tipoSelecionado =
          document.getElementById("tipoConcilicacao").value || "rodada1";
        const razaoFile = document.getElementById("razaoFile").files[0];
        const balanceteFile = document.getElementById("balanceteFile").files[0];
        const contasFile = document.getElementById("contasFile").files[0];
        const pagamentosFile =
          document.getElementById("pagamentosFile").files[0];
        const notasFiscaisFile =
          document.getElementById("notasFiscaisFile").files[0];

        if (
          !fornecedor ||
          !razaoFile ||
          !balanceteFile ||
          !contasFile ||
          !pagamentosFile ||
          (tipoSelecionado === "rodada4" && !notasFiscaisFile)
        ) {
          alert(
            "Preencha o fornecedor, selecione os arquivos obrigat√≥rios e, na Rodada 4, informe tamb√©m o arquivo de Notas Fiscais."
          );
          return;
        }

        // guarda a √∫ltima rodada escolhida
        ultimaRodadaSelecionada = tipoSelecionado;

        const formData = new FormData();
        formData.append("fornecedor", fornecedor);
        formData.append("rodada", tipoSelecionado);
        formData.append("razao", razaoFile);
        formData.append("balancete", balanceteFile);
        formData.append("contas_pagar", contasFile);
        formData.append("pagamentos", pagamentosFile);
        if (notasFiscaisFile) {
          formData.append("notas_fiscais", notasFiscaisFile);
        }

        try {
          setLoading(true);
          const resp = await fetch("/api/fornecedores/conciliar/rodada1", {
            method: "POST",
            body: formData,
          });

          const contentType = resp.headers.get("content-type") || "";
          let data;
          if (contentType.includes("application/json")) {
            data = await resp.json();
          } else {
            const text = await resp.text();
            throw new Error("Resposta n√£o √© JSON: " + text);
          }

          if (!resp.ok) {
            throw new Error(data.detail || data.error || "Erro ao conciliar.");
          }

          renderResultado(data);
        } catch (err) {
          console.error(err);
          statusMensagem.textContent =
            "Erro ao executar concilia√ß√£o: " + err.message;
          alert("Erro ao executar concilia√ß√£o: " + err.message);
        } finally {
          setLoading(false);
        }
      });
    </script>
  </body>
</html>
